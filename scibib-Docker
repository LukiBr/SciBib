FROM php:7-apache

# Install Scibib dependencies
RUN apt-get update -y && apt-get install -y libpng-dev zlib1g-dev libicu-dev g++
RUN docker-php-ext-install gd mysqli pdo_mysql intl mbstring zip

# Install composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Enable apache mods
RUN a2enmod php7
RUN a2enmod rewrite

# Expose apache
EXPOSE 80

# Copy this repo into place.
RUN mkdir /var/www/SciBib/
RUN chown www-data /var/www/SciBib
ADD SciBib/ /var/www/SciBib/

# Update the default apache site with the config we created.
ADD apache-config.conf /etc/apache2/sites-enabled/000-default.conf

# Fix server name
RUN echo "127.0.0.1 localhost" | tee /etc/hosts && echo "ServerName localhost" | tee /etc/apache2/conf-available/servername.conf
RUN a2enconf servername

# Restart apache to fix server name and other issues
RUN service apache2 restart

# Run composer and install dependencies
WORKDIR /var/www/SciBib
RUN composer update

# Set configs for the database
# Create Salt
RUN salt=$(date +%s | sha256sum | base64 | head -c 32 ; echo) && sed -r -i "s/'salt' => '.*'/'salt' => '${salt}'/g" config/app.php
# Change mysql user settings
RUN sed -r -i "s/'username' => '.*'/'username' => 'scibib'/g" config/app.php
RUN sed -r -i "s/'password' => '.*'/'password' => 'ahsh5Aepingai7mik8chahgoh'/g" config/app.php
RUN sed -r -i "s/'database' => '.*'/'database' => 'scibib'/g" config/app.php
# RUN sed -r -i "s/\/\/'port' => 'nonstandard_port_number'/'port' => '3310'/g" config/app.php
RUN sed -r -i "s/'host' => 'localhost'/'host' => 'db'/g" config/app.php

# Remove debug option
RUN sed -r -i "s/'debug' => true/'debug' => false/g" config/app.php

# Set the owner of the files to the apache server
RUN chown www-data:www-data -R *

# Add create login script for easier creation of super admin
ADD startuplogin/createlogin.sh createlogin.sh
RUN chmod +x createlogin.sh
